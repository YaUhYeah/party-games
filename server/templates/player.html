<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Play Game - Party Games Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <!-- Debug Overlay -->
    <div id="debugOverlay" class="fixed top-0 right-0 bg-black/80 text-white p-4 m-4 rounded-lg text-sm font-mono max-w-xs overflow-auto max-h-96 hidden z-50">
        <div class="flex justify-between items-center mb-2">
            <h3 class="font-bold">Debug Info</h3>
            <button onclick="window.gameState.toggleDebug()" class="text-gray-400 hover:text-white px-2">[X]</button>
        </div>
        <div class="text-xs mb-2">Press Ctrl+Shift+D to toggle</div>
        <pre id="debugInfo" class="whitespace-pre-wrap text-xs leading-tight"></pre>
    </div>

    <!-- Connection Status Toast -->
    <div id="connectionToast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-black/80 text-white px-4 py-2 rounded-full text-sm hidden">
        <span id="connectionToastText"></span>
    </div>

    <div class="container mx-auto">
        <div class="game-container">
            <!-- Player Name Input -->
            <div id="nameInput" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-indigo-500/90 to-purple-600/90 backdrop-blur-sm">
                <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md w-11/12 md:w-96 transform transition-all">
                    <h2 class="text-3xl font-bold text-indigo-600 mb-6">Join Game</h2>
                    <div id="connectionStatus" class="text-sm text-gray-600 mb-4">
                        Connecting to server...
                    </div>
                    <div id="roomInfo" class="text-sm bg-gray-100 p-2 rounded mb-4">
                        Room ID: <span class="font-mono">{{ room_id }}</span>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="playerName" class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                            <input type="text" id="playerName" 
                                   class="w-full p-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:border-indigo-400 transition-all"
                                   placeholder="Enter your name">
                        </div>
                        <button onclick="window.gameState.joinGame()" 
                                class="w-full bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 active:bg-indigo-800 transition-all transform hover:scale-[1.02] flex items-center justify-center space-x-2">
                            <span class="join-text font-semibold">Join Game</span>
                            <span class="loading-spinner hidden">
                                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Area -->
            <div id="gameArea" class="hidden">
                <!-- Game content will be dynamically added here -->
            </div>
        </div>
    </div>

    <script>
        // Initialize game state
        window.gameState = {
            socket: null,
            roomId: "{{ room_id }}",
            hasJoined: false,
            debugVisible: false,
            debugState: {
                socketConnected: false,
                lastError: null,
                joinAttempts: 0,
                events: []
            },

            // Initialize the game
            init() {
                console.log('Initializing game with room ID:', this.roomId);
                this.initSocket();
                this.addKeyboardListeners();
                this.updateDebugInfo();
            },

            // Initialize socket connection
            initSocket() {
                this.socket = io({
                    path: '/socket.io/',
                    transports: ['polling', 'websocket'],
                    reconnectionAttempts: 10,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    timeout: 20000,
                    query: { room_id: this.roomId }
                });

                this.setupSocketListeners();
            },

            // Set up socket event listeners
            setupSocketListeners() {
                this.socket.on('connect', () => {
                    console.log('Socket connected');
                    this.updateConnectionStatus('Connected to server');
                    this.debugState.socketConnected = true;
                    this.updateDebugInfo();
                });

                this.socket.on('connect_error', (error) => {
                    console.error('Socket connection error:', error);
                    this.updateConnectionStatus('Connection error: ' + error.message, true);
                    this.debugState.socketConnected = false;
                    this.debugState.lastError = {
                        time: new Date().toISOString(),
                        type: 'connect_error',
                        message: error.message
                    };
                    this.updateDebugInfo();
                });

                this.socket.on('join_confirmed', (data) => {
                    console.log('Join confirmed:', data);
                    this.hasJoined = true;
                    this.showNotification('Successfully joined the game!');
                    this.transitionToGame();
                });

                this.socket.on('join_error', (error) => {
                    console.error('Join error:', error);
                    this.showNotification(error.message || 'Failed to join game', 'error');
                    this.resetJoinButton();
                });
            },

            // Join game function
            joinGame() {
                const playerName = document.getElementById('playerName').value.trim();
                console.log('Attempting to join with name:', playerName);

                if (!playerName) {
                    this.showNotification('Please enter your name', 'error');
                    return;
                }

                this.debugState.joinAttempts++;
                this.updateDebugInfo();

                const joinButton = document.querySelector('button[onclick="window.gameState.joinGame()"]');
                if (joinButton) {
                    joinButton.disabled = true;
                    joinButton.querySelector('.join-text').textContent = 'Joining...';
                    joinButton.querySelector('.loading-spinner').classList.remove('hidden');
                }

                this.socket.emit('join_room', {
                    room_id: this.roomId,
                    player_name: playerName,
                    is_host: false
                });
            },

            // UI helper functions
            updateConnectionStatus(status, isError = false) {
                const statusEl = document.getElementById('connectionStatus');
                if (statusEl) {
                    statusEl.textContent = status;
                    statusEl.className = `text-sm ${isError ? 'text-red-600' : 'text-gray-600'} mb-4`;
                }
            },

            showNotification(message, type = 'info') {
                const toast = document.getElementById('connectionToast');
                const toastText = document.getElementById('connectionToastText');
                
                if (toast && toastText) {
                    toastText.textContent = message;
                    toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-full text-sm z-50 ${
                        type === 'error' ? 'bg-red-600 text-white' : 'bg-black/80 text-white'
                    }`;
                    toast.classList.remove('hidden');
                    
                    setTimeout(() => {
                        toast.classList.add('hidden');
                    }, 3000);
                }
            },

            resetJoinButton() {
                const joinButton = document.querySelector('button[onclick="window.gameState.joinGame()"]');
                if (joinButton) {
                    joinButton.disabled = false;
                    joinButton.querySelector('.join-text').textContent = 'Join Game';
                    joinButton.querySelector('.loading-spinner').classList.add('hidden');
                }
            },

            transitionToGame() {
                const nameInput = document.getElementById('nameInput');
                const gameArea = document.getElementById('gameArea');
                
                if (nameInput && gameArea) {
                    nameInput.style.opacity = '0';
                    nameInput.style.transition = 'opacity 0.5s ease-out';
                    
                    setTimeout(() => {
                        nameInput.classList.add('hidden');
                        gameArea.classList.remove('hidden');
                        gameArea.style.opacity = '0';
                        requestAnimationFrame(() => {
                            gameArea.style.transition = 'opacity 0.5s ease-in';
                            gameArea.style.opacity = '1';
                        });
                    }, 500);
                }
            },

            // Debug functions
            toggleDebug() {
                const overlay = document.getElementById('debugOverlay');
                this.debugVisible = !this.debugVisible;
                if (overlay) {
                    overlay.classList.toggle('hidden', !this.debugVisible);
                    if (this.debugVisible) {
                        this.updateDebugInfo();
                    }
                }
            },

            updateDebugInfo() {
                const debugInfo = document.getElementById('debugInfo');
                if (debugInfo) {
                    debugInfo.textContent = JSON.stringify({
                        roomId: this.roomId,
                        socketConnected: this.debugState.socketConnected,
                        hasJoined: this.hasJoined,
                        joinAttempts: this.debugState.joinAttempts,
                        lastError: this.debugState.lastError,
                        events: this.debugState.events
                    }, null, 2);
                }
            },

            addKeyboardListeners() {
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                        this.toggleDebug();
                    }
                });

                // Add enter key listener for the name input
                document.getElementById('playerName').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.joinGame();
                    }
                });
            }
        };

        // Initialize the game when the page loads
        window.addEventListener('load', () => {
            window.gameState.init();
        });
    </script>
</body>
</html>