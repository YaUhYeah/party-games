<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Host Game - Party Games Hub</title>
    
    <!-- Core styles -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Core dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    
    <style>
        /* Base styles */
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: system-ui, -apple-system, sans-serif;
        }

        /* Connection status styles */
        #connectionStatus {
            background-color: rgba(255, 255, 255, 0.9);
            color: #1a202c;
        }
        #connectionStatus.connected {
            background-color: #f0fff4;
            color: #22543d;
        }
        #connectionStatus.connected .status-indicator {
            background-color: #48bb78;
        }
        #connectionStatus.error {
            background-color: #fff5f5;
            color: #742a2a;
        }
        #connectionStatus.error .status-indicator {
            background-color: #f56565;
        }
        #connectionStatus.connecting {
            background-color: #fffff0;
            color: #744210;
        }
        #connectionStatus.connecting .status-indicator {
            background-color: #ecc94b;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Game container styles */
        .game-container {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            backdrop-filter: blur(10px);
        }

        /* Timer styles */
        .timer-bar {
            transition: width 100ms linear;
        }
        .timer-bar.warning {
            background-color: #ecc94b;
        }
        .timer-bar.danger {
            background-color: #f56565;
        }

        /* Animation keyframes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(-10px); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        /* Toast styles */
        .toast {
            animation: fadeIn 0.3s ease-out;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .toast.error {
            background-color: #f56565;
        }
        .toast.hiding {
            animation: fadeOut 0.3s ease-out forwards;
        }

        /* Game board styles */
        .board-square {
            background-color: #4a5568;
            border-radius: 0.5rem;
            transition: background-color 200ms;
        }
        .board-square.active {
            background-color: #5a67d8;
        }
        .board-square.safe {
            background-color: #48bb78;
        }
        .board-square.danger {
            background-color: #f56565;
        }

        /* Player marker styles */
        .player-marker {
            transition: transform 500ms cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <div class="game-container p-8 max-w-4xl mx-auto">
            <div id="waitingState">
                <h2 class="text-2xl font-bold text-center mb-4">Waiting for Players</h2>
                <div id="playerList" class="space-y-2"></div>
                <div class="mt-8 text-center">
                    <button onclick="PartyGames.startGame('chinese_whispers')" 
                            class="bg-indigo-600 text-white px-6 py-2 rounded-lg mr-4 hover:bg-indigo-700 transition">
                        Start Drawing Game
                    </button>
                    <button onclick="PartyGames.startGame('trivia')" 
                            class="bg-purple-600 text-white px-6 py-2 rounded-lg mr-4 hover:bg-purple-700 transition">
                        Start Trivia Game
                    </button>
                    <button onclick="PartyGames.startGame('chase')" 
                            class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition">
                        Start Chase Game
                    </button>
                </div>
            </div>
            
            <div id="triviaState" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-4">Trivia Game</h2>
                <div id="triviaQuestion" class="bg-gray-100 p-4 rounded-lg mb-4"></div>
                <div id="triviaAnswers" class="grid grid-cols-2 gap-4"></div>
                <div id="triviaTimer" class="mt-4 text-center">
                    <div class="text-xl font-bold mb-2">Time Remaining: <span id="triviaTimerText">0</span>s</div>
                    <div class="bg-gray-200 rounded-full h-2">
                        <div id="triviaTimerBar" class="bg-indigo-500 h-2 rounded-full transition-all duration-100" style="width: 100%"></div>
                    </div>
                </div>
                <div id="triviaProgress" class="mt-4">
                    <div class="flex justify-between text-sm text-gray-500 mb-2">
                        <span>Players Answered</span>
                        <span id="triviaProgressText">0/0</span>
                    </div>
                    <div class="bg-gray-200 rounded-full h-2">
                        <div id="triviaProgressBar" class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            
            <div id="chaseState" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-4">The Chase</h2>
                <div id="chaseBoard" class="grid grid-cols-7 gap-2 bg-gray-100 p-4 rounded-lg relative">
                    <div id="chaserMarker" class="absolute transition-all duration-500 ease-in-out">
                        <div class="w-10 h-10 bg-red-500 rounded-full shadow-lg flex items-center justify-center text-white font-bold">C</div>
                    </div>
                    <div id="contestantMarker" class="absolute transition-all duration-500 ease-in-out">
                        <div class="w-10 h-10 bg-blue-500 rounded-full shadow-lg flex items-center justify-center text-white font-bold"></div>
                    </div>
                </div>
                <div id="chaseQuestion" class="mt-4 bg-gray-100 p-4 rounded-lg"></div>
                <div id="chaseTimer" class="mt-4 text-center">
                    <div class="text-xl font-bold mb-2">Time Remaining: <span id="chaseTimerText">0</span>s</div>
                    <div class="bg-gray-200 rounded-full h-2">
                        <div id="chaseTimerBar" class="bg-indigo-500 h-2 rounded-full transition-all duration-100" style="width: 100%"></div>
                    </div>
                </div>
                <div id="chasePowerUps" class="mt-4 grid grid-cols-3 gap-4">
                    <div class="bg-gray-100 p-3 rounded-lg text-center">
                        <div class="text-yellow-500 text-xl mb-1">‚ö°</div>
                        <div class="text-sm">Double Steps</div>
                        <div id="powerUpDoubleSteps" class="text-xs text-gray-500">1 left</div>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-lg text-center">
                        <div class="text-blue-500 text-xl mb-1">üõ°Ô∏è</div>
                        <div class="text-sm">Shield</div>
                        <div id="powerUpShield" class="text-xs text-gray-500">1 left</div>
                    </div>
                    <div class="bg-gray-100 p-3 rounded-lg text-center">
                        <div class="text-purple-500 text-xl mb-1">‚è∞</div>
                        <div class="text-sm">Time Freeze</div>
                        <div id="powerUpTimeFreeze" class="text-xs text-gray-500">1 left</div>
                    </div>
                </div>
            </div>
            
            <div id="drawingState" class="hidden">
                <h2 class="text-2xl font-bold text-center mb-4">Drawing Game</h2>
                <canvas id="drawingCanvas" class="bg-white border-2 border-gray-200 rounded-lg"></canvas>
                <div id="drawingTimer" class="mt-4 text-center">
                    <div class="text-xl font-bold mb-2">Time Remaining: <span id="drawingTimerText">0</span>s</div>
                    <div class="bg-gray-200 rounded-full h-2">
                        <div id="drawingTimerBar" class="bg-indigo-500 h-2 rounded-full transition-all duration-100" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection status -->
    <div id="connectionStatus" class="fixed top-4 left-4 px-4 py-2 rounded-full text-sm font-medium hidden">
        <span class="flex items-center">
            <span class="w-2 h-2 rounded-full mr-2 status-indicator"></span>
            <span class="status-text"></span>
        </span>
    </div>

    <!-- Toast container -->
    <div id="toastContainer" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 space-y-2 z-50"></div>

    <!-- Game initialization script -->
    <script>
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', function() {
            // Game state
            window.PartyGames = {
                state: {
                    currentGame: null,
                    round: 0,
                    totalRounds: 0,
                    players: {},
                    scores: {},
                    timers: {},
                    gameStartTime: null,
                    roundStartTime: null,
                    roomId: null
                },

                // Timer management
                timers: {
                    active: {},
                    
                    start(id, duration, onTick, onComplete) {
                        this.stop(id);
                        
                        const startTime = Date.now();
                        const timer = {
                            startTime,
                            duration,
                            interval: setInterval(() => {
                                const elapsed = (Date.now() - startTime) / 1000;
                                const remaining = Math.max(0, duration - elapsed);
                                
                                if (remaining === 0) {
                                    this.stop(id);
                                    if (onComplete) onComplete();
                                } else if (onTick) {
                                    onTick(remaining);
                                }
                            }, 100)
                        };
                        
                        this.active[id] = timer;
                        return timer;
                    },
                    
                    stop(id) {
                        if (this.active[id]) {
                            clearInterval(this.active[id].interval);
                            delete this.active[id];
                        }
                    },
                    
                    stopAll() {
                        Object.keys(this.active).forEach(id => this.stop(id));
                    }
                },

                // UI management
                ui: {
                    updateTimer(id, timeLeft, duration) {
                        const timer = document.getElementById(`${id}Text`);
                        const timerBar = document.getElementById(`${id}Bar`);
                        if (timer && timerBar) {
                            timer.textContent = Math.ceil(timeLeft);
                            const percent = (timeLeft / duration) * 100;
                            timerBar.style.width = `${percent}%`;
                            
                            timerBar.classList.remove('warning', 'danger');
                            if (timeLeft <= 5) {
                                timerBar.classList.add('danger');
                            } else if (timeLeft <= 10) {
                                timerBar.classList.add('warning');
                            }
                        }
                    },
                    
                    updateProgress(answered, total) {
                        const progressText = document.getElementById('triviaProgressText');
                        const progressBar = document.getElementById('triviaProgressBar');
                        if (progressText && progressBar) {
                            progressText.textContent = `${answered}/${total}`;
                            const percent = (answered / total) * 100;
                            progressBar.style.width = `${percent}%`;
                        }
                    },
                    
                    showGameState(state) {
                        ['waitingState', 'chaseState', 'triviaState', 'drawingState'].forEach(id => {
                            const element = document.getElementById(id);
                            if (element) element.classList.add('hidden');
                        });
                        
                        const stateElement = document.getElementById(`${state}State`);
                        if (stateElement) stateElement.classList.remove('hidden');
                    },
                    
                    updateRoundInfo(round, total) {
                        const currentRound = document.getElementById('triviaCurrentRound');
                        const totalRounds = document.getElementById('triviaTotalRounds');
                        if (currentRound) currentRound.textContent = round;
                        if (totalRounds) totalRounds.textContent = total;
                    }
                },

                // Toast notifications
                toast: {
                    show(message, type = 'info') {
                        const container = document.getElementById('toastContainer');
                        if (!container) return;

                        const toast = document.createElement('div');
                        toast.className = `toast ${type === 'error' ? 'error' : ''}`;
                        toast.textContent = message;
                        container.appendChild(toast);
                        
                        setTimeout(() => {
                            toast.classList.add('hiding');
                            setTimeout(() => toast.remove(), 300);
                        }, 3000);
                    }
                },

                // Connection management
                connection: {
                    status: null,
                    
                    updateStatus(status, message) {
                        const statusElement = document.getElementById('connectionStatus');
                        if (!statusElement) return;
                        
                        statusElement.classList.remove('hidden', 'connected', 'error', 'connecting');
                        statusElement.classList.add(status);
                        
                        const textElement = statusElement.querySelector('.status-text');
                        if (textElement) textElement.textContent = message;
                        
                        this.status = status;
                    }
                },

                // Game initialization
                init() {
                    // Get room ID from URL
                    const urlParams = new URLSearchParams(window.location.search);
                    this.state.roomId = urlParams.get('room_id');
                    
                    if (!this.state.roomId) {
                        this.toast.show('No room ID provided', 'error');
                        return;
                    }
                    
                    // Initialize socket connection
                    this.initSocket();
                    
                    // Show initial game state
                    this.ui.showGameState('waiting');
                },

                // Socket initialization
                initSocket() {
                    const socket = io({
                        query: { room_id: this.state.roomId },
                        reconnection: true,
                        reconnectionAttempts: 5,
                        reconnectionDelay: 1000,
                        reconnectionDelayMax: 5000,
                        timeout: 20000
                    });

                    // Connection events
                    socket.on('connect', () => {
                        this.connection.updateStatus('connected', 'Connected to server');
                    });

                    socket.on('connect_error', (error) => {
                        this.connection.updateStatus('error', 'Connection error: ' + error.message);
                        this.toast.show('Connection error: ' + error.message, 'error');
                    });

                    socket.on('disconnect', (reason) => {
                        this.connection.updateStatus('error', 'Disconnected: ' + reason);
                        this.toast.show('Disconnected: ' + reason, 'error');
                    });

                    // Game events
                    socket.on('game_started', (data) => this.handleGameStart(data));
                    socket.on('game_error', (data) => this.handleGameError(data));
                    socket.on('player_joined', (data) => this.handlePlayerJoined(data));
                    socket.on('player_left', (data) => this.handlePlayerLeft(data));
                    socket.on('answer_progress', (data) => this.handleAnswerProgress(data));
                    socket.on('question_results', (data) => this.handleQuestionResults(data));
                    socket.on('game_complete', (data) => this.handleGameComplete(data));

                    // Store socket instance
                    this.socket = socket;
                },

                // Event handlers
                handleGameStart(data) {
                    this.state.currentGame = data.game_type;
                    this.state.round = data.round;
                    this.state.totalRounds = data.total_rounds;
                    this.state.gameStartTime = Date.now();
                    
                    this.ui.showGameState(data.game_type);
                    
                    if (data.game_type === 'trivia') {
                        this.initTrivia(data);
                    } else if (data.game_type === 'chase') {
                        this.initChase(data);
                    }
                },

                handleGameError(data) {
                    console.error('Game error:', data.message);
                    this.toast.show(data.message, 'error');
                },

                handlePlayerJoined(data) {
                    this.updatePlayerList(data.players);
                    this.toast.show(`${data.new_player} joined the game`);
                },

                handlePlayerLeft(data) {
                    this.updatePlayerList(data.players);
                    this.toast.show(`${data.player_name} left the game`);
                },

                handleAnswerProgress(data) {
                    this.ui.updateProgress(data.answered, data.total);
                },

                handleQuestionResults(data) {
                    // Implementation will be added in game-specific code
                },

                handleGameComplete(data) {
                    this.timers.stopAll();
                    this.ui.showGameState('complete');
                    // Additional implementation will be added
                },

                // Player list management
                updatePlayerList(players) {
                    const playerGrid = document.getElementById('playerList');
                    if (!playerGrid) return;
                    
                    playerGrid.innerHTML = '';
                    players.forEach(player => {
                        const playerElement = document.createElement('div');
                        playerElement.className = 'flex items-center justify-between bg-white/50 rounded-lg p-3';
                        playerElement.innerHTML = `
                            <span class="font-medium">${player.name}</span>
                            <span class="text-sm text-gray-600">${player.score || 0} pts</span>
                        `;
                        playerGrid.appendChild(playerElement);
                    });
                    
                    // Update player count
                    const playerCount = document.getElementById('playerCount');
                    if (playerCount) playerCount.textContent = players.length;
                },

                // Game start
                startGame(gameType) {
                    if (!this.socket || !this.state.roomId) {
                        this.toast.show('Not connected to server', 'error');
                        return;
                    }

                    this.socket.emit('start_game', {
                        room_id: this.state.roomId,
                        game_type: gameType
                    });
                }
            };

            // Initialize game
            PartyGames.init();
        });
    </script>
</body>
</html>